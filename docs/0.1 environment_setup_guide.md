# Google ADK 营销代理系统环境搭建指南

## 🖥️ Mac M 系列芯片环境搭建完整指南

本指南将帮助您在 Mac M 系列芯片（Apple Silicon）上搭建 Google ADK 营销代理系统的完整开发环境。

## 📋 系统要求

- **操作系统：** macOS 12.0+ (Monterey 或更高版本)
- **芯片：** Apple M1/M2/M3 系列
- **内存：** 建议 8GB 以上
- **存储：** 至少 5GB 可用空间

## 🔧 环境搭建步骤

### 步骤 1: 安装 Homebrew（包管理器）

```bash
# 安装 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 添加到 PATH（根据终端类型选择）
# 对于 zsh (默认)
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
source ~/.zshrc

# 对于 bash
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.bash_profile
source ~/.bash_profile

# 验证安装
brew --version
```

### 步骤 2: 安装 Python 3.9+

```bash
# 安装 Python（推荐 3.9 或 3.10）
brew install python@3.10

# 验证安装
python3 --version
pip3 --version

# 创建软链接（可选，便于使用）
echo 'alias python=python3' >> ~/.zshrc
echo 'alias pip=pip3' >> ~/.zshrc
source ~/.zshrc
```

### 步骤 3: 安装 Git

```bash
# 安装 Git
brew install git

# 验证安装
git --version

# 配置 Git（替换为您的信息）
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

### 步骤 4: 安装 Google Cloud SDK

```bash
# 下载并安装 Google Cloud SDK
curl https://sdk.cloud.google.com | bash

# 重启终端或重新加载配置
source ~/.zshrc

# 初始化 gcloud
gcloud init

# 验证安装
gcloud --version
```

**gcloud 初始化配置：**
1. 选择或创建 Google Cloud 项目
2. 选择默认计算区域（推荐：us-central1）
3. 启用必要的 API

### 步骤 5: 启用必要的 Google Cloud API

```bash
# 设置项目 ID（替换为您的项目 ID）
export GOOGLE_CLOUD_PROJECT="your-project-id"

# 启用必要的 API
gcloud services enable aiplatform.googleapis.com
gcloud services enable storage.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable secretmanager.googleapis.com

# 验证 API 状态
gcloud services list --enabled
```

### 步骤 6: 创建服务账号和密钥

```bash
# 创建服务账号
gcloud iam service-accounts create adk-marketing-agent \
    --description="ADK Marketing Agent Service Account" \
    --display-name="ADK Marketing Agent"

# 授予必要权限
gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \
    --member="serviceAccount:adk-marketing-agent@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \
    --role="roles/aiplatform.user"

gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \
    --member="serviceAccount:adk-marketing-agent@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \
    --role="roles/storage.admin"

# 创建并下载密钥文件
gcloud iam service-accounts keys create ~/adk-service-account-key.json \
    --iam-account=adk-marketing-agent@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com
```

### 步骤 7: 设置环境变量

```bash
# 编辑环境配置文件
nano ~/.zshrc

# 添加以下环境变量（根据实际情况修改）
export GOOGLE_CLOUD_PROJECT="your-project-id"
export GOOGLE_CLOUD_LOCATION="us-central1"
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/adk-service-account-key.json"
export PYTHONPATH="$PYTHONPATH:$HOME/adk-samples/python"

# 重新加载配置
source ~/.zshrc

# 验证环境变量
echo $GOOGLE_CLOUD_PROJECT
echo $GOOGLE_CLOUD_LOCATION
echo $GOOGLE_APPLICATION_CREDENTIALS
```

### 步骤 8: 创建项目目录和虚拟环境

```bash
# 创建项目目录
mkdir -p ~/adk-marketing-project
cd ~/adk-marketing-project

# 创建 Python 虚拟环境
python3 -m venv adk-env

# 激活虚拟环境
source adk-env/bin/activate

# 升级 pip
pip install --upgrade pip

# 验证虚拟环境
which python
which pip
```

### 步骤 9: 克隆 ADK 示例代码

```bash
# 克隆 Google ADK 示例仓库
git clone https://github.com/google/adk-samples.git
cd adk-samples

# 查看项目结构
ls -la
tree python/agents/marketing-agency/ -L 3
```

### 步骤 10: 安装 Python 依赖

```bash
# 进入营销代理目录
cd python/agents/marketing-agency

# 查看是否有 requirements.txt
ls -la

# 如果没有 requirements.txt，创建一个
cat > requirements.txt << EOF
google-adk>=0.1.0
google-cloud-aiplatform>=1.38.0
google-generativeai>=0.3.0
python-dotenv>=1.0.0
requests>=2.31.0
whois>=0.9.27
EOF

# 安装依赖
pip install -r requirements.txt

# 验证安装
pip list | grep google
```

### 步骤 11: 创建配置文件

```bash
# 创建 .env 文件
cat > .env << EOF
# Google Cloud 配置
GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT
GOOGLE_CLOUD_LOCATION=$GOOGLE_CLOUD_LOCATION
GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS

# API 配置
VERTEX_AI_ENDPOINT=https://$GOOGLE_CLOUD_LOCATION-aiplatform.googleapis.com

# 模型配置
GEMINI_MODEL=gemini-2.5-pro-preview-05-06
IMAGEN_MODEL=imagen-3.0-generate-002

# 调试模式
DEBUG=True
EOF

# 设置文件权限
chmod 600 .env
```

### 步骤 12: 验证环境配置

```bash
# 创建测试脚本
cat > test_environment.py << 'EOF'
#!/usr/bin/env python3

import os
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

def test_environment():
    print("🔍 环境配置检查")
    print("=" * 50)
    
    # 检查环境变量
    required_vars = [
        'GOOGLE_CLOUD_PROJECT',
        'GOOGLE_CLOUD_LOCATION',
        'GOOGLE_APPLICATION_CREDENTIALS'
    ]
    
    for var in required_vars:
        value = os.getenv(var)
        if value:
            print(f"✅ {var}: {value}")
        else:
            print(f"❌ {var}: 未设置")
    
    # 检查服务账号密钥文件
    key_file = os.getenv('GOOGLE_APPLICATION_CREDENTIALS')
    if key_file and os.path.exists(key_file):
        print(f"✅ 服务账号密钥文件存在: {key_file}")
    else:
        print(f"❌ 服务账号密钥文件不存在: {key_file}")
    
    # 测试 Google Cloud 连接
    try:
        from google.cloud import aiplatform
        aiplatform.init(
            project=os.getenv('GOOGLE_CLOUD_PROJECT'),
            location=os.getenv('GOOGLE_CLOUD_LOCATION')
        )
        print("✅ Google Cloud AI Platform 连接成功")
    except Exception as e:
        print(f"❌ Google Cloud AI Platform 连接失败: {e}")
    
    # 测试 ADK 导入
    try:
        import google.adk
        print("✅ Google ADK 导入成功")
    except ImportError as e:
        print(f"❌ Google ADK 导入失败: {e}")
    
    print("\n🎉 环境检查完成！")

if __name__ == "__main__":
    test_environment()
EOF

# 运行测试
python test_environment.py
```

## 🚨 常见问题解决

### 问题 1: M 系列芯片兼容性

```bash
# 如果遇到架构兼容性问题，使用 Rosetta
arch -x86_64 pip install package-name

# 或者设置环境变量
export ARCHFLAGS="-arch arm64"
```

### 问题 2: Python 版本冲突

```bash
# 使用 pyenv 管理多个 Python 版本
brew install pyenv
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.zshrc
echo 'eval "$(pyenv init --path)"' >> ~/.zshrc
echo 'eval "$(pyenv init -)"' >> ~/.zshrc

# 安装特定 Python 版本
pyenv install 3.10.12
pyenv global 3.10.12
```

### 问题 3: Google Cloud 认证问题

```bash
# 重新认证
gcloud auth login
gcloud auth application-default login

# 检查当前认证状态
gcloud auth list
gcloud config list
```

### 问题 4: 权限问题

```bash
# 检查服务账号权限
gcloud projects get-iam-policy $GOOGLE_CLOUD_PROJECT

# 重新设置权限
gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \
    --member="serviceAccount:adk-marketing-agent@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \
    --role="roles/aiplatform.admin"
```

## 📝 环境配置清单

- [ ] Homebrew 安装完成
- [ ] Python 3.9+ 安装完成
- [ ] Git 配置完成
- [ ] Google Cloud SDK 安装并初始化
- [ ] 必要的 Google Cloud API 已启用
- [ ] 服务账号和密钥创建完成
- [ ] 环境变量设置完成
- [ ] 虚拟环境创建并激活
- [ ] ADK 示例代码克隆完成
- [ ] Python 依赖安装完成
- [ ] 配置文件创建完成
- [ ] 环境测试通过

## 🎯 下一步

环境搭建完成后，您可以：
1. 运行营销代理系统测试
2. 探索各个子代理的功能
3. 自定义代理配置
4. 开发自己的营销策略

## 📞 技术支持

如果在环境搭建过程中遇到问题，可以：
1. 查看 Google ADK 官方文档
2. 检查 Google Cloud 控制台日志
3. 运行环境测试脚本诊断问题
4. 查看相关错误日志文件

祝您环境搭建顺利！🚀